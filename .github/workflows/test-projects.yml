name: Test All Projects

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run tests daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  test-portfolio:
    name: Test Portfolio Pages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Test main portfolio page
      run: |
        echo "üß™ Testing main portfolio page..."
        # Check if index.html exists and is valid
        if [ ! -f "index.html" ]; then
          echo "‚ùå index.html not found!"
          exit 1
        fi
        
        # Check for basic structure
        if ! grep -q "Maximilian Haak" index.html; then
          echo "‚ùå Portfolio title not found!"
          exit 1
        fi
        
        echo "‚úÖ Main portfolio page OK"
    
    - name: Test project landing pages
      run: |
        echo "üß™ Testing project landing pages..."
        
        # Test Age of Max page
        if [ ! -f "projects/age-of-max.html" ]; then
          echo "‚ùå projects/age-of-max.html not found!"
          exit 1
        fi
        
        # Test FireCastle page
        if [ ! -f "projects/firecastle.html" ]; then
          echo "‚ùå projects/firecastle.html not found!"
          exit 1
        fi
        
        # Test AuTune Online page
        if [ ! -f "projects/autune-online.html" ]; then
          echo "‚ùå projects/autune-online.html not found!"
          exit 1
        fi
        
        # Test Albert page
        if [ ! -f "projects/albert.html" ]; then
          echo "‚ùå projects/albert.html not found!"
          exit 1
        fi
        
        # Test SoundofLvke page
        if [ ! -f "projects/soundoflvke.html" ]; then
          echo "‚ùå projects/soundoflvke.html not found!"
          exit 1
        fi

        # Test TestoMax page
        if [ ! -f "projects/testomax.html" ]; then
          echo "‚ùå projects/testomax.html not found!"
          exit 1
        fi
        
        echo "‚úÖ All project landing pages exist"
    
    - name: Validate HTML syntax
      run: |
        echo "üß™ Validating HTML files..."
        
        # Check for common HTML issues (unclosed tags, etc)
        for file in index.html projects/*.html impressum.html datenschutz.html; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            
            # Count opening and closing tags (basic check)
            opening_divs=$(grep -o '<div' "$file" | wc -l)
            closing_divs=$(grep -o '</div>' "$file" | wc -l)
            
            if [ "$opening_divs" -ne "$closing_divs" ]; then
              echo "‚ö†Ô∏è  Warning: $file may have mismatched div tags (opening: $opening_divs, closing: $closing_divs)"
            fi
          fi
        done
        
        echo "‚úÖ HTML validation complete"
    
    - name: Check for broken internal links
      run: |
        echo "üß™ Checking for broken internal links..."
        
        # Check if all referenced resources exist
        echo "Checking CSS files..."
        if [ ! -f "style.css" ]; then
          echo "‚ùå style.css not found!"
          exit 1
        fi
        
        if [ ! -f "projects/style.css" ]; then
          echo "‚ùå projects/style.css not found!"
          exit 1
        fi
        
        echo "Checking JavaScript files..."
        if [ ! -f "script.js" ]; then
          echo "‚ùå script.js not found!"
          exit 1
        fi
        
        echo "Checking resource directory..."
        if [ ! -d "res" ]; then
          echo "‚ùå res/ directory not found!"
          exit 1
        fi
        
        echo "‚úÖ Internal resources OK"

  test-ageofmax:
    name: Test AgeOfMax Project
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'AgeOfMax/package-lock.json'
    
    - name: Check AgeOfMax submodule
      run: |
        echo "üß™ Testing AgeOfMax submodule..."
        
        if [ ! -d "AgeOfMax" ]; then
          echo "‚ùå AgeOfMax directory not found!"
          exit 1
        fi
        
        if [ ! -f "AgeOfMax/package.json" ]; then
          echo "‚ùå AgeOfMax/package.json not found!"
          exit 1
        fi
        
        echo "‚úÖ AgeOfMax submodule structure OK"
    
    - name: Install AgeOfMax dependencies
      working-directory: AgeOfMax
      run: |
        echo "üì¶ Installing dependencies..."
        npm ci 2>/dev/null || npm install
    
    - name: Build AgeOfMax
      working-directory: AgeOfMax
      run: |
        echo "üî® Building AgeOfMax..."
        npx vite build --mode production
        
        if [ ! -d "dist" ]; then
          echo "‚ùå Build failed - dist directory not created!"
          exit 1
        fi
        
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå Build failed - index.html not found in dist!"
          exit 1
        fi
        
        echo "‚úÖ AgeOfMax build successful"
    
    - name: Check for TypeScript errors
      working-directory: AgeOfMax
      run: |
        echo "üß™ Checking TypeScript..."
        npx tsc --noEmit || echo "‚ö†Ô∏è  TypeScript warnings found (non-blocking)"

  test-firecastle:
    name: Test FireCastle Project
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Check FireCastle submodule
      run: |
        echo "üß™ Testing FireCastle submodule..."
        
        if [ ! -d "FireCastle" ]; then
          echo "‚ùå FireCastle directory not found!"
          exit 1
        fi
        
        echo "‚úÖ FireCastle submodule exists"
    
    - name: Check FireCastle structure
      run: |
        echo "üß™ Checking FireCastle file structure..."
        
        # Check for required files
        if [ -f "FireCastle/index.html" ]; then
          echo "‚úÖ index.html found"
        else
          echo "‚ö†Ô∏è  FireCastle/index.html not found"
        fi
        
        if [ -d "FireCastle/css" ]; then
          echo "‚úÖ css directory found"
        else
          echo "‚ö†Ô∏è  FireCastle/css directory not found"
        fi
        
        if [ -d "FireCastle/js" ]; then
          echo "‚úÖ js directory found"
        else
          echo "‚ö†Ô∏è  FireCastle/js directory not found"
        fi
        
        # Check if it's a Node.js project with API
        if [ -f "FireCastle/package.json" ]; then
          echo "‚úÖ package.json found (Node.js API project)"
          cat FireCastle/package.json | grep -E '"(express|node-cache|winston)"' && echo "‚úÖ API dependencies detected"
        fi
    
    - name: Document API endpoints
      run: |
        echo "üìù Documenting FireCastle API endpoints..."
        echo "Based on documentation, FireCastle provides:"
        echo "  - GET /api/clan - Clan information"
        echo "  - GET /api/player - Player data"
        echo "  - GET /api/clanwar - Clan war status"
        echo "  - GET /api/clan/stats - Extended clan statistics"
        echo "  - GET /api/player/stats - Detailed player statistics"
        echo ""
        echo "‚ö†Ô∏è  Note: API tests require deployed environment with Clash of Clans API key"
        echo "These endpoints should be tested in the live environment."

  test-autuneonline:
    name: Test AuTuneOnline Project
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Check AuTuneOnline submodule
      run: |
        echo "üß™ Testing AuTuneOnline submodule..."
        
        if [ ! -d "AuTuneOnline" ]; then
          echo "‚ùå AuTuneOnline directory not found!"
          exit 1
        fi
        
        echo "‚úÖ AuTuneOnline submodule exists"
    
    - name: Check AuTuneOnline structure
      run: |
        echo "üß™ Checking AuTuneOnline file structure..."
        
        if [ -f "AuTuneOnline/public/index.html" ]; then
          echo "‚úÖ public/index.html found"
        else
          echo "‚ö†Ô∏è  AuTuneOnline/public/index.html not found"
        fi
        
        if [ -f "AuTuneOnline/public/style.css" ]; then
          echo "‚úÖ public/style.css found"
        else
          echo "‚ö†Ô∏è  AuTuneOnline/public/style.css not found"
        fi
        
        if [ -f "AuTuneOnline/public/app.js" ]; then
          echo "‚úÖ public/app.js found"
        else
          echo "‚ö†Ô∏è  AuTuneOnline/public/app.js not found"
        fi
        
        echo "‚úÖ AuTuneOnline structure check complete"
    
    - name: Verify Web Audio API usage
      run: |
        echo "üß™ Checking for Web Audio API implementation..."
        
        if [ -f "AuTuneOnline/public/app.js" ]; then
          if grep -q "AudioContext\|webkitAudioContext" AuTuneOnline/public/app.js; then
            echo "‚úÖ Web Audio API detected"
          fi
          
          if grep -q "AnalyserNode\|analyser" AuTuneOnline/public/app.js; then
            echo "‚úÖ Audio analysis implementation detected"
          fi
        fi

  test-testomax:
    name: Test TestoMax
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Test project structure
      run: |
        echo "üß™ Testing TestoMax structure..."
        
        if [ -d "TestoMax" ]; then
          echo "‚úÖ TestoMax directory exists"
          ls -la TestoMax/
        else
          echo "‚ùå TestoMax directory missing"
          exit 1
        fi
        
        # Check for key files
        if [ -f "TestoMax/index.html" ] || [ -f "TestoMax/public/index.html" ]; then
          echo "‚úÖ Entry point found"
        else
          echo "‚ö†Ô∏è  No index.html found in root or public/"
        fi

  test-external-links:
    name: Test External Project Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test SoundofLvke link
      run: |
        echo "üß™ Testing external project link..."
        
        # Check if the link is present in the HTML
        if grep -q "soundoflvke.github.io" index.html; then
          echo "‚úÖ SoundofLvke link found in index.html"
        else
          echo "‚ö†Ô∏è  SoundofLvke link not found"
        fi
        
        if [ -f "projects/soundoflvke.html" ]; then
          echo "‚úÖ SoundofLvke project page exists"
        fi
    
    - name: Test external link availability (HTTP check)
      run: |
        echo "üåê Testing external link availability..."
        
        # Test if soundoflvke.github.io is reachable
        if curl -s -o /dev/null -w "%{http_code}" https://soundoflvke.github.io | grep -q "200\|301\|302"; then
          echo "‚úÖ SoundofLvke website is reachable"
        else
          echo "‚ö†Ô∏è  SoundofLvke website returned unexpected status or is unreachable"
        fi

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test-portfolio, test-ageofmax, test-firecastle, test-autuneonline, test-testomax, test-external-links]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# üìä Project Testing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Project | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Portfolio Pages | ${{ needs.test-portfolio.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AgeOfMax | ${{ needs.test-ageofmax.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| FireCastle | ${{ needs.test-firecastle.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AuTuneOnline | ${{ needs.test-autuneonline.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| TestoMax | ${{ needs.test-testomax.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| External Links | ${{ needs.test-external-links.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ HTML structure validation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Internal link checking" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Build verification" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Project structure validation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ External link availability" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Tests run on $(date)*" >> $GITHUB_STEP_SUMMARY
